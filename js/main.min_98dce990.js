var __reflect=this&&this.__reflect||function(t,e,n){t.__class__=e,n?n.push(e):n=[e],t.__types__=t.__types__?n.concat(t.__types__):n},__extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},__awaiter=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(i,o){function s(t){try{c(r.next(t))}catch(e){o(e)}}function a(t){try{c(r["throw"](t))}catch(e){o(e)}}function c(t){t.done?i(t.value):new n(function(e){e(t.value)}).then(s,a)}c((r=r.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function n(t){return function(e){return r([t,e])}}function r(n){if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,o&&(s=o[2&n[0]?"return":n[0]?"throw":"next"])&&!(s=s.call(o,n[1])).done)return s;switch(o=0,s&&(n=[0,s.value]),n[0]){case 0:case 1:s=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,o=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){c.label=n[1];break}if(6===n[0]&&c.label<s[1]){c.label=s[1],s=n;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(n);break}s[2]&&c.ops.pop(),c.trys.pop();continue}n=e.call(t,c)}catch(r){n=[6,r],o=0}finally{i=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var i,o,s,a,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:n(0),"throw":n(1),"return":n(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a},logic;!function(t){var e;!function(e){var n;!function(t){t[t.White=0]="White",t[t.Green=1]="Green",t[t.Blue=2]="Blue",t[t.Red=3]="Red"}(n=e.Type||(e.Type={})),function(t){function e(e){switch(e){case t.Red:case t.Blue:case t.Green:return!0;case t.White:default:return!1}}function n(e,n){switch(e){case t.Red:return n===t.Red||n===t.Blue||n===t.Green;case t.Blue:return n===t.Blue||n===t.Green;case t.Green:return n===t.Green;case t.White:default:return!1}}t.active=e,t.absorbable=n}(n=e.Type||(e.Type={}));var r;!function(t){t[t.Free=0]="Free",t[t.Lock=1]="Lock",t[t.Stop=2]="Stop"}(r=e.Status||(e.Status={}));var i;!function(t){t[t.Idle=0]="Idle",t[t.Left=1]="Left",t[t.Down=2]="Down",t[t.Up=3]="Up",t[t.Right=4]="Right"}(i=e.Action||(e.Action={})),function(e){function n(n){switch(n){default:case e.Idle:return t.Vec2.Zero;case e.Left:return t.Vec2.Left;case e.Down:return t.Vec2.Down;case e.Up:return t.Vec2.Up;case e.Right:return t.Vec2.Right}}function r(t){switch(t){default:return e.Idle;case e.Left:return e.Right;case e.Down:return e.Up;case e.Up:return e.Down;case e.Right:return e.Left}}e.Move=[e.Left,e.Down,e.Up,e.Right],e.Enum=[e.Idle,e.Left,e.Down,e.Up,e.Right],e.toVec2=n,e.opposite=r}(i=e.Action||(e.Action={}))}(e=t.Cube||(t.Cube={}))}(logic||(logic={}));var utils;!function(t){var e;!function(t){t.BGM_NORMAL="sound_music_normal",t.BGM_HEAVY="sound_music_heavy",t.CUBE_CONTROL="sound_effect_note_move",t.CUBE_CONNECT="sound_effect_note_connect",t.LEVEL_ENTER="sound_effect_note_01",t.LEVEL_CLEAR="sound_effect_level_clear"}(e=t.Track||(t.Track={}));var n=function(){function t(){this.playing=new Map}return Object.defineProperty(t,"instance",{get:function(){return this.instance_||(this.instance_=new this)},enumerable:!0,configurable:!0}),t.prototype.sound=function(t){var e=this.tryToFind(t);void 0!==e?e.play(0,1).volume=.2:console.error("Musician: Cannot find sound",t)},t.prototype.music=function(t){this.tryToStop(t);var e=this.tryToFind(t);if(void 0!==e){var n=e.play(0,0);n.volume=.1,this.playing.set(t,n)}else console.error("Musician: Cannot find music",t)},t.prototype.stop=function(t){this.tryToStop(t)===!1&&console.error("Musician: Cannot find and stop",t)},t.prototype.tryToFind=function(t){return RES.hasRes(t)?RES.getRes(t):void 0},t.prototype.tryToStop=function(t){if(this.playing.has(t)){var e=this.playing.get(t);if(void 0!==e)return this.playing["delete"](t),e.stop(),!0}return!1},t}();t.Musician=n,__reflect(n.prototype,"utils.Musician")}(utils||(utils={}));var logic;!function(t){var e,n=t.Cube.Action;!function(t){function e(e,n){return void 0===e?new i:n instanceof Array&&"boolean"==typeof e?new o(e,n):"boolean"==typeof e?t.None:(e=e.filter(function(t){return t.done===!1}),0===e.length?new i:1===e.length?e[0]:new s(e))}t.create=e}(e=t.Behavior||(t.Behavior={}));var r=function(){function t(){}return Object.defineProperty(t.prototype,"action",{get:function(){return n.Idle},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"done",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.next=function(){return this},t}();__reflect(r.prototype,"Dead",["logic.IBehavior"]);var i=function(){function t(){this.cache=void 0}return Object.defineProperty(t.prototype,"action",{get:function(){return void 0===this.cache?n.Idle:this.cache},set:function(t){this.cache=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"done",{get:function(){return void 0===this.cache},enumerable:!0,configurable:!0}),t.prototype.next=function(){return this.cache=void 0,this},t}();__reflect(i.prototype,"Idle",["logic.IBehavior"]);var o=function(){function t(t,e){this.isloop=t,this.sequence=e,this.cache=void 0,this.count=0,this.index=0,this.sequence=e.filter(function(t){return t[1]>0})}return Object.defineProperty(t.prototype,"action",{get:function(){return this.done?n.Idle:void 0!==this.cache?this.cache:this.sequence[this.index][0]},set:function(t){this.cache=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"done",{get:function(){return void 0===this.cache&&this.index===this.sequence.length},enumerable:!0,configurable:!0}),t.prototype.next=function(){if(void 0!==this.cache)return this.cache=void 0,this;var t=this.sequence.length;if(this.index===t)return this;var e=this.sequence[this.index][1];return this.count+=1,this.count===e&&(this.index+=1,this.index===t&&this.isloop&&(this.index=0),this.count=0),this},t}();__reflect(o.prototype,"Move",["logic.IBehavior"]);var s=function(){function t(t){this.moves=t,this.cache=void 0,0===this.moves.length&&this.moves.push(new i)}return Object.defineProperty(t.prototype,"action",{get:function(){if(void 0===this.cache){var t=this.moves[0].action;this.cache=this.moves.every(function(e){return e.action===t})?t:n.Idle}return this.cache},set:function(t){this.moves.forEach(function(e){return e.action=t})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"done",{get:function(){return this.moves.every(function(t){return t.done})},enumerable:!0,configurable:!0}),t.prototype.next=function(){return this.cache=void 0,this.moves.forEach(function(t){return t.next()}),this.moves=this.moves.filter(function(t,e){return 0===e||t.done===!1}),this},t}();__reflect(s.prototype,"Moves",["logic.IBehavior"]),function(t){t.None=new r}(e=t.Behavior||(t.Behavior={}))}(logic||(logic={}));var logic;!function(t){var e;!function(e){var n;!function(e){function n(t){switch(t){default:case"I":case"i":return e.Action.Idle;case"L":case"l":return e.Action.Left;case"D":case"d":return e.Action.Down;case"U":case"u":return e.Action.Up;case"R":case"r":return e.Action.Right}}function r(t){return t.map(function(t){var e=t[0],r=t[1];return[n(e),r]})}function i(t){switch(t){default:case"W":case"w":return e.Type.White;case"G":case"g":return e.Type.Green;case"B":case"b":return e.Type.Blue;case"R":case"r":return e.Type.Red}}e.Type=t.Cube.Type,e.Action=t.Cube.Action,e.toAction=n,e.toActions=r,e.toType=i}(n=e.Cube||(e.Cube={}))}(e=t.Seed||(t.Seed={}));var n;!function(t){function e(t){var e=t;return n(e.head)&&r(e.size)&&i(e.cube)&&o(e.dest)}function n(t){var e=t;return"string"==typeof e.title}function r(t){var e=t;return"number"==typeof e.width||"number"==typeof e.height}function i(t){return Array.isArray(t)}function o(t){return Array.isArray(t)}t.isSeed=e}(n=t.Guard||(t.Guard={}))}(logic||(logic={}));var logic;!function(t){var e=function(){function t(t,e){void 0===e&&(e=0),this.mem=new Int32Array(2),t instanceof Array?(this[0]=Number(t[0]),this[1]=Number(t[1])):(this[0]=t,this[1]=e)}return Object.defineProperty(t.prototype,"x",{get:function(){return this.mem[0]},set:function(t){this.mem[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.mem[1]},set:function(t){this.mem[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,0,{get:function(){return this.mem[0]},set:function(t){this.mem[0]=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,1,{get:function(){return this.mem[1]},set:function(t){this.mem[1]=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return 2},enumerable:!0,configurable:!0}),t.prototype.plus=function(t){return this.x+=t.x,this.y+=t.y,this},Object.defineProperty(t,"Zero",{get:function(){return new t(0,0)},enumerable:!0,configurable:!0}),Object.defineProperty(t,"Left",{get:function(){return new t(-1,0)},enumerable:!0,configurable:!0}),Object.defineProperty(t,"Down",{get:function(){return new t(0,1)},enumerable:!0,configurable:!0}),Object.defineProperty(t,"Up",{get:function(){return new t(0,-1)},enumerable:!0,configurable:!0}),Object.defineProperty(t,"Right",{get:function(){return new t(1,0)},enumerable:!0,configurable:!0}),t}();t.Vec2=e,__reflect(e.prototype,"logic.Vec2")}(logic||(logic={}));var utils;!function(t){var e=function(){function t(){this.stack=new Array}return Object.defineProperty(t,"instance",{get:function(){return this.instance_||(this.instance_=new this)},enumerable:!0,configurable:!0}),t.prototype.push=function(t){t&&this.main&&(this.stack.push(t),this.main.addChild(t))},t.prototype.pop=function(){if(this.stack.length>0){var t=this.stack[this.stack.length-1];this.stack.pop(),t.parent===this.main&&this.main.removeChild(t)}},t.prototype.replace=function(t){this.stack.length>0&&t&&(this.pop(),this.push(t))},t}();t.Director=e,__reflect(e.prototype,"utils.Director")}(utils||(utils={}));var input;!function(t){var e;!function(t){t[t._0=48]="_0",t[t._1=49]="_1",t[t._2=50]="_2",t[t._3=51]="_3",t[t._4=52]="_4",t[t._5=53]="_5",t[t._6=54]="_6",t[t._7=55]="_7",t[t._8=56]="_8",t[t._9=57]="_9",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.NUM_0=96]="NUM_0",t[t.NUM_1=97]="NUM_1",t[t.NUM_2=98]="NUM_2",t[t.NUM_3=99]="NUM_3",t[t.NUM_4=100]="NUM_4",t[t.NUM_5=101]="NUM_5",t[t.NUM_6=102]="NUM_6",t[t.NUM_7=103]="NUM_7",t[t.NUM_8=104]="NUM_8",t[t.NUM_9=105]="NUM_9",t[t.NUM_MUL=106]="NUM_MUL",t[t.NUM_ADD=107]="NUM_ADD",t[t.NUM_ENTER=13]="NUM_ENTER",t[t.NUM_SUB=109]="NUM_SUB",t[t.NUM_DECIMAL=110]="NUM_DECIMAL",t[t.NUM_DIV=111]="NUM_DIV",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.F13=124]="F13",t[t.F14=125]="F14",t[t.F15=126]="F15",t[t.BACKSPACE=8]="BACKSPACE",t[t.TAB=9]="TAB",t[t.ENTER=13]="ENTER",t[t.SHIFT=16]="SHIFT",t[t.CTRL=17]="CTRL",t[t.CAPS_LOCK=20]="CAPS_LOCK",t[t.ESC=27]="ESC",t[t.SPACE=32]="SPACE",t[t.PAGE_UP=33]="PAGE_UP",t[t.PAGE_DOWN=34]="PAGE_DOWN",t[t.END=35]="END",t[t.HOME=36]="HOME",t[t.LEFT=37]="LEFT",t[t.UP=38]="UP",t[t.RIGHT=39]="RIGHT",t[t.DOWN=40]="DOWN",t[t.INSERT=45]="INSERT",t[t.DELETE=46]="DELETE",t[t.NUM_LOCK=144]="NUM_LOCK",t[t.SCROLL_LOCK=145]="SCROLL_LOCK",t[t.PAUSE=19]="PAUSE",t[t.BREAK=19]="BREAK",t[t.COLON=186]="COLON",t[t.SEMICOLON=186]="SEMICOLON",t[t.EQUAL=187]="EQUAL",t[t.PLUS=187]="PLUS",t[t.SUB=189]="SUB",t[t.UNDERLINE=189]="UNDERLINE",t[t.SLASH=191]="SLASH",t[t.DIV=191]="DIV",t[t.QUESTION=191]="QUESTION",t[t.TILDE=192]="TILDE",t[t.LBRACKET=219]="LBRACKET",t[t.BACKSLASH=220]="BACKSLASH",t[t.RBRACKET=221]="RBRACKET",t[t.QUOTE=222]="QUOTE",t[t.DOT=190]="DOT",t[t.DECIMAL=190]="DECIMAL"}(e=t.Key||(t.Key={})),function(t){t.Enums=new Set([t._0,t._1,t._2,t._3,t._4,t._5,t._6,t._7,t._8,t._9,t.A,t.B,t.C,t.D,t.E,t.F,t.G,t.H,t.I,t.J,t.K,t.L,t.M,t.N,t.O,t.P,t.Q,t.R,t.S,t.T,t.U,t.V,t.W,t.X,t.Y,t.Z,t.NUM_0,t.NUM_1,t.NUM_2,t.NUM_3,t.NUM_4,t.NUM_5,t.NUM_6,t.NUM_7,t.NUM_8,t.NUM_9,t.NUM_MUL,t.NUM_ADD,t.NUM_ENTER,t.NUM_SUB,t.NUM_DECIMAL,t.NUM_DIV,t.F1,t.F2,t.F3,t.F4,t.F5,t.F6,t.F7,t.F8,t.F9,t.F10,t.F11,t.F12,t.F13,t.F14,t.F15,t.BACKSPACE,t.TAB,t.ENTER,t.SHIFT,t.CTRL,t.CAPS_LOCK,t.ESC,t.SPACE,t.PAGE_UP,t.PAGE_DOWN,t.END,t.HOME,t.LEFT,t.UP,t.RIGHT,t.DOWN,t.INSERT,t.DELETE,t.NUM_LOCK,t.SCROLL_LOCK,t.PAUSE,t.BREAK,t.COLON,t.SEMICOLON,t.EQUAL,t.PLUS,t.SUB,t.UNDERLINE,t.SLASH,t.DIV,t.QUESTION,t.TILDE,t.LBRACKET,t.BACKSLASH,t.RBRACKET,t.QUOTE,t.DOT,t.DECIMAL])}(e=t.Key||(t.Key={}))}(input||(input={}));var input;!function(t){var e;!function(t){var e=function(t){function e(e,n,r,i,o){void 0===i&&(i=!1),void 0===o&&(o=!1);var s=t.call(this,r,i,o)||this;return s.key=e,s.keyboard=n,s}return __extends(e,t),e.prototype.isDown=function(t){return this.keyboard.isKeyDown(t)},e.prototype.isUp=function(t){return this.keyboard.isKeyUp(t)},Object.defineProperty(e.prototype,"keys",{get:function(){return this.keys},enumerable:!0,configurable:!0}),e.KEY_UP="input.Key.Event.KEY_UP",e.KEY_DOWN="input.Key.Event.KEY_DOWN",e}(egret.Event);t.Event=e,__reflect(e.prototype,"input.Key.Event")}(e=t.Key||(t.Key={}));var n=function(t){function n(){var n=t.call(this)||this;n.keys=new Set;var r=n;return document.onkeydown=function(t){var n=t||window.event||arguments.callee.caller.arguments[0],i=n.keyCode;if(e.Enums.has(i)!==!1&&r.keys.has(i)!==!0){r.keys.add(i);var o=new e.Event(i,r,e.Event.KEY_DOWN,!0,!0);r.dispatchEvent(o)}},document.onkeyup=function(t){var n=t||window.event||arguments.callee.caller.arguments[0],i=n.keyCode;if(e.Enums.has(i)!==!1&&r.keys.has(i)!==!1){r.keys["delete"](i);var o=new e.Event(i,r,e.Event.KEY_UP,!0,!0);r.dispatchEvent(o)}},n}return __extends(n,t),n.prototype.isKeyDown=function(t){return this.keys.has(t)},n.prototype.isKeyUp=function(t){return this.isKeyDown(t)===!1},n}(egret.EventDispatcher);t.KeyBoard=n,__reflect(n.prototype,"input.KeyBoard")}(input||(input={}));var AssetAdapter=function(){function t(){}return t.prototype.getAsset=function(t,e,n){function r(r){e.call(n,r,t)}if(RES.hasRes(t)){var i=RES.getRes(t);i?r(i):RES.getResAsync(t,r,this)}else RES.getResByUrl(t,r,this,RES.ResourceItem.TYPE_IMAGE)},t}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var ThemeAdapter=function(){function t(){}return t.prototype.getTheme=function(t,e,n,r){function i(t){e.call(r,t)}function o(e){e.resItem.url==t&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),n.call(r))}var s=this;"undefined"!=typeof generateEUI?egret.callLater(function(){e.call(r,generateEUI)},this):"undefined"!=typeof generateEUI2?RES.getResByUrl("resource/gameEui.json",function(t,n){window.JSONParseClass.setData(t),i(t),egret.callLater(function(){e.call(r,generateEUI2)},s)},this,RES.ResourceItem.TYPE_JSON):(RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),RES.getResByUrl(t,i,this,RES.ResourceItem.TYPE_TEXT))},t}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var logic;!function(t){var e=function(){function t(t){this.sources=t,this.indexes=new Map(this.sources.map(function(t,e){return[t,e]})),this.parents=this.sources.map(function(t,e){return e})}return t.prototype.same=function(t,e){var n=this.root(t),r=this.root(e);return void 0===n||void 0===r?!1:n===r},t.prototype.join=function(t,e){var n=this.root(t),r=this.root(e);return void 0===n||void 0===r?!1:(n!==r&&(this.parents[r]=this.parents[n]),!0)},t.prototype.root=function(t){var e=this.index(t);if(!(void 0===e||e>=this.parents.length)){for(var n=e;this.parents[n]!=n;)n=this.parents[n];for(var r=e;r!==n;)i=[this.parents[r],n],r=i[0],this.parents[r]=i[1];return n;var i}},t.prototype.groups=function(){for(var t=new Array(this.parents.length),e=0;e<this.parents.length;e++){var n=this.root(e);void 0!==n&&n!==e&&void 0!==this.sources[n]&&(void 0===t[n]&&(t[n]=new Array(this.sources[n])),t[n].push(this.sources[e]))}return t.filter(function(t){return void 0!==t})},t.prototype.alones=function(){var t=this;return this.sources.filter(function(e,n){return t.parents[n]===n})},t.prototype.index=function(t){return"number"!=typeof t?this.indexes.get(t):t>this.parents.length?void 0:t},t}();t.DisjointSet=e,__reflect(e.prototype,"logic.DisjointSet")}(logic||(logic={}));var Musician=utils.Musician.instance,Director=utils.Director.instance,Main=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.createChildren=function(){t.prototype.createChildren.call(this),egret.lifecycle.addLifecycleListener(function(t){}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},egret.registerImplementation("eui.IAssetAdapter",new AssetAdapter),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.onRunning()["catch"](function(t){console.error(t)})},e.prototype.onRunning=function(){return __awaiter(this,void 0,void 0,function(){var t,n,r,i,o,s,a=this;return __generator(this,function(c){switch(c.label){case 0:return c.trys.push([0,4,,5]),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return c.sent(),[4,new Promise(function(t,e){new eui.Theme("resource/default.thm.json",a.stage).addEventListener(eui.UIEvent.COMPLETE,function(){return t()},a)})];case 2:return c.sent(),[4,RES.loadGroup(e.Resources[0],0)];case 3:return c.sent(),[3,5];case 4:throw t=c.sent(),new Error(t);case 5:n=new scene.Loading,this.addChild(n),n.track=e.Resources,r=0,i=e.Resources,c.label=6;case 6:if(!(r<i.length))return[3,12];o=i[r],c.label=7;case 7:return c.trys.push([7,9,,10]),[4,RES.loadGroup(o,0,n)];case 8:return c.sent(),[3,10];case 9:throw s=c.sent(),new Error(s);case 10:n.count(),c.label=11;case 11:return r++,[3,6];case 12:return this.onHelloWorld(),this.setChildIndex(n,this.numChildren-1),egret.Tween.get(n).to({alpha:0},2e3,egret.Ease.circOut).call(function(){a.removeChild(n)}),[2]}})})},e.prototype.onHelloWorld=function(){Director.main=this,Director.push(new scene.World)},e.Resources=["loading","level","sound"],e}(eui.UILayer);__reflect(Main.prototype,"Main");var logic;!function(t){var e=function(){function t(e,r){if(this.load=e,this.save=r,this.node=new Array,this.data=t.Script.Default(),e.has(t.RESOURCE_NAME)){var i=e.get(t.RESOURCE_NAME);if(Array.isArray(i)===!1)throw new Error("Narrator: Invalid Map "+i);if(i.some(function(t){return n.isNode(t)===!1}))throw new Error("Narrator: Invalid Map "+i);(o=this.node).push.apply(o,i)}if(r.has(t.MEMORY_NAME)){var i=r.get(t.MEMORY_NAME);if(!n.isScript(i))throw new Error("Narrator: Invalid Data "+i);this.data=i}else{if(!(this.node.length>0))throw new Error("Narrator: Data not exists");this.data.milestone=this.node[0].name}var o}return t.prototype.zero=function(){if(this.node.length<0)throw new Error("Narrator: Map is empty");return this.data.milestone=this.node[0].name,this.tell()},t.prototype.tell=function(){return this.seed(this.data.milestone)},t.prototype.next=function(e){var n=this.data.milestone,r=this.node.find(function(t){return t.name===n});if(void 0===r)throw new Error("Narrator: Cannot find Node "+n);var i=r["case"].find(function(n){return t.match(n.cond,e)});if(void 0===i&&(i=r["case"].find(function(t){return void 0===t.cond})),void 0===i)throw new Error("Narrator: Missing Defualt at "+n);return this.data.milestone=i.next,this.seed(i.next)},t.prototype.seed=function(t){if(this.load.has(t)!==!1){var e=this.load.get(t);return n.isSeed(e)?e:void console.error("Narrator: Invalid Seed",t,"With",e)}},t.match=function(t,e){if(void 0===t||void 0===e)return!1;if(Array.isArray(t)===!1||Array.isArray(e)===!1)return!1;for(var n=Math.min(t.length,e.length),r=0;n>r;r++)if(t[r]!==e[r])return!1;return!0},t.RESOURCE_NAME="level_index",t.MEMORY_NAME="data",t}();t.Narrator=e,__reflect(e.prototype,"logic.Narrator"),function(t){var e;!function(t){function e(){return{milestone:""}}t.Default=e}(e=t.Script||(t.Script={}))}(e=t.Narrator||(t.Narrator={}));var n;!function(t){function e(t){var e=t;return"string"==typeof e.name&&Array.isArray(e["case"])&&e["case"].every(function(t){return n(t)})}function n(t){var e=t;return"string"==typeof e.next}function r(t){var e=t;return"string"==typeof e.milestone}t.isNode=e,t.isScript=r}(n=t.Guard||(t.Guard={}))}(logic||(logic={}));var entity;!function(t){function e(t,e){var n=t.width,r=t.height,i=e.stageWidth,o=e.stageHeight,s=Math.min(i/n,o/r);return{tlx:(i-n*s)/2,tly:(o-r*s)/2,sid:s}}function n(t,e,n,r,i){void 0===r&&(r=a.White),void 0===i&&(i=0);var o=[16777215,16777215];switch(r){default:case a.White:o[0]=16777215,o[1]=13684944;break;case a.Green:o[0]=12311481,o[1]=7314029;break;case a.Blue:o[0]=11457521,o[1]=6853815;break;case a.Red:o[0]=16555164,o[1]=13327195}var s=.03*n,c=[s,s,n-.5*s,n-.5*s];t.graphics.beginFill(o[0]),t.graphics.drawRect(c[0],c[1],c[2],c[3]),0!==(1&i)&&t.graphics.drawRect(c[0]-s,c[1],2*s,c[3]),0!==(2&i)&&t.graphics.drawRect(c[0],c[1]-s,c[2],2*s),t.graphics.endFill();var u=[.5*s,n/6,n,7*n/6];e.graphics.beginFill(o[1]),e.graphics.moveTo(u[2],u[0]),e.graphics.lineTo(u[3],u[1]),e.graphics.lineTo(u[3],u[3]),e.graphics.lineTo(u[2],u[2]),e.graphics.lineTo(u[2],u[0]),e.graphics.moveTo(u[0],u[2]),e.graphics.lineTo(u[2],u[2]),e.graphics.lineTo(u[3],u[3]),e.graphics.lineTo(u[1],u[3]),e.graphics.lineTo(u[0],u[2]),e.graphics.endFill()}var r=logic.Behavior,i=logic.Cube.Action,o=logic.Cube.Status,s=logic.Seed,a=logic.Cube.Type,c=function(t){function e(e,n,r){var i=t.call(this)||this;return i.type_=n,i.world_=e,i.entity_=new Array,i.action_=r,i.status_=o.Free,i.modify_=!1,i}return __extends(e,t),Object.defineProperty(e.prototype,"type",{get:function(){return this.type_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"live",{get:function(){return this.entity_.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"world",{get:function(){return this.world_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"moving",{get:function(){return!this.action_.done},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"active",{get:function(){return a.active(this.type)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"entity",{get:function(){return this.entity_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"behavior",{get:function(){return this.action_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"action",{get:function(){return this.action_.action},set:function(t){this.action_.action=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"status",{get:function(){return this.status_},set:function(t){this.status_=t},enumerable:!0,configurable:!0}),e.prototype.absorbable=function(t){return a.absorbable(this.type,t.type)},e.prototype.absorb=function(t){var e=this;this.modify_=!0;for(var n=0,i=t.filter(function(t){return t!==e});n<i.length;n++){var s=i[n];(a=this.entity_).push.apply(a,s.entity),s.entity.length=0,s.status=o.Stop}this.action_=r.create(t.filter(function(t){return t.absorbable(e)}).concat(this).map(function(t){return t.behavior}));var a},e.prototype.commit=function(){if(this.live){if(this.modify_){for(var t=0,e=this.entity_;t<e.length;t++){var n=e[t];n.attach(this)}for(var r=0,i=this.entity;r<i.length;r++){var n=i[r];n.commit()}this.modify_=!1}if(this.moving){for(var s=0,a=this.entity_;s<a.length;s++){var n=a[s];n.change(this.action,this.status)}for(var c=0,u=this.entity;c<u.length;c++){var n=u[c];n.commit()}this.status=o.Free,this.behavior.next()}}},e}(egret.DisplayObjectContainer);t.Cube=c,__reflect(c.prototype,"entity.Cube",["logic.ICube"]);var u=function(){function t(t,e,n,r){this.owner=n,this.layer=r,this.modify=!1,this.moving=!1,this.action=void 0,this.status=void 0,this.parts=[new egret.Shape,new egret.Shape],r[1].addChild(this.parts[0]),r[3].addChild(this.parts[1]),n.entity.push(this),this.x_=t,this.y_=e,this.onPaint(),this.onPlace()}return t.prototype.attach=function(t){this.modify=!0,this.owner=t},t.prototype.change=function(t,e){this.action=t,this.status=e,this.moving=!0},t.prototype.commit=function(){if(this.modify===!0&&(this.onPaint(),this.modify=!1),this.moving===!0){if(void 0!==this.action&&this.action!==i.Idle&&void 0!==this.status&&this.status!==o.Stop){var t=i.toVec2(this.action).plus(this);switch(this.status){case o.Free:this.x_=t.x,this.y_=t.y,this.onAnimationMove();break;case o.Lock:this.onAnimationLock(t.x,t.y);break;default:this.onPlace()}}else this.onPlace();this.action=void 0,this.status=void 0,this.moving=!1}},Object.defineProperty(t.prototype,"x",{get:function(){return this.x_},set:function(t){this.x!==t&&(this.x_=t,this.moving=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.y_},set:function(t){this.x!==t&&(this.y_=t,this.moving=!0)},enumerable:!0,configurable:!0}),t.prototype.onPlace=function(){for(var t=e(this.owner.world.size,this.layer[0].stage),n=t.tlx,r=t.tly,i=t.sid,o=0,s=this.parts;o<s.length;o++){var a=s[o];a.x=n+this.x*i,a.y=r+this.y*i}},t.prototype.onAnimationMove=function(){for(var t=e(this.owner.world.size,this.layer[0].stage),n=t.tlx,r=t.tly,i=t.sid,o=n+this.x*i,s=r+this.y*i,a=0,c=this.parts;a<c.length;a++){var u=c[a];u.x+=u.x<o?1:u.x>o?-1:0,u.y+=u.y<s?1:u.y>s?-1:0,egret.Tween.get(u).to({x:o,y:s},248)}},t.prototype.onAnimationLock=function(t,n){for(var r=e(this.owner.world.size,this.layer[0].stage),i=r.tlx,o=r.tly,s=r.sid,a=i+this.x*s,c=o+this.y*s,u=(a+i+t*s)/2,h=(c+o+n*s)/2,f=0,l=this.parts;f<l.length;f++){var p=l[f];p.x+=p.x<u?1:p.x>u?-1:0,p.y+=p.y<h?1:p.y>h?-1:0,egret.Tween.get(p).to({x:u,y:h},140,egret.Ease.sineOut).to({x:a,y:c},100,egret.Ease.sineIn)}},t.prototype.onPaint=function(){for(var t=e(this.owner.world.size,this.layer[0].stage),r=(t.tlx,t.tly,t.sid),i=0,o=this.parts;i<o.length;i++){var s=o[i];s.graphics.clear()}for(var a=0,c=0,u=this.owner.entity;c<u.length;c++){var h=u[c];h.x===this.x_-1&&h.y===this.y_?a|=1:h.x===this.x_&&h.y===this.y_-1&&(a|=2)}n(this.parts[0],this.parts[1],r,this.owner.type,a)},t}();__reflect(u.prototype,"Unit",["logic.IUnit","logic.IVec2"]);var h=function(){function t(t,r,i,o){this.x=t,this.y=r,this.owner=i,this.layer=o,this.parts=[new egret.Shape,new egret.Shape],o[0].addChild(this.parts[0]),o[2].addChild(this.parts[1]);var s=e(this.owner.size,this.layer[0].stage),a=s.tlx,c=s.tly,u=s.sid;n(this.parts[0],this.parts[1],u);for(var h=0,f=this.parts;h<f.length;h++){var l=f[h];l.x=a+this.x*u,l.y=c+this.y*u,l.alpha=.4,egret.Tween.get(l,{loop:!0}).to({alpha:.2},2e3,egret.Ease.sineInOut).to({alpha:.4},2e3,egret.Ease.sineInOut)}}return t}();t.Dest=h,__reflect(h.prototype,"entity.Dest",["logic.IVec2"]);var f=function(){function t(t,e){this.world=t,this.layer=e}return t.prototype.create=function(t){if(Array.isArray(t)){var e=new h(t[0],t[1],this.world,this.layer);return e}for(var n=s.Cube.toType(t.type),i=void 0===t.move?r.create():r.create(t.move.loop,s.Cube.toActions(t.move.path)),o=new c(this.world,n,i),a=0,f=t.body;a<f.length;a++){var l=f[a];new u(l[0],l[1],o,this.layer).attach(o)}for(var p=0,d=o.entity;p<d.length;p++){var y=d[p];y.commit()}return o},t}();t.CubeFactory=f,__reflect(f.prototype,"entity.CubeFactory")}(entity||(entity={}));var logic;!function(t){var e;!function(e){function n(e,n,r){for(var o=e.filter(function(t){return t.live&&t.active}).map(function(t,e){return new a(t,e)}),s=new t.DisjointSet(o),c=new t.ItemGrid(n,r),u=new t.EdgeGrid(n,r),h=0,f=o;h<f.length;h++){var l=f[h];c.set(l.cube.entity,l),u.put(l.cube.entity)}for(var p=function(t){for(var e=function(e){var n=e.shift();return void 0===n?"break":void c.get(u.out(n.cube.entity)).filter(function(e){return e.cube.active&&e.cube.absorbable(t.cube)===!1&&t.cube.absorbable(e.cube)===!0&&s.same(t,e)===!1}).forEach(function(n){s.join(t.index,n.index),e.push(n)})},n=new Array(t);0!==n.length;){var r=e(n);if("break"===r)break}},d=0,y=o;d<y.length;d++){var l=y[d];p(l)}for(var v=0,g=s.groups();v<g.length;v++){var _=g[v];i(_.map(function(t){return t.cube}))}}function r(e,n,r){for(var a=new t.ItemGrid(n,r),u=new t.EdgeGrid(n,r),h=e.filter(function(t){return t.live}).map(function(t,e){return new c(t,e)}),f=new t.DisjointSet(h),l=h.filter(function(t){return t.cube.moving}),p=l.filter(function(t){return t.cube.action!==o.Idle}),d=0,y=h;d<y.length;d++){var v=y[d];a.set(v.cube.entity,v)}for(var g=0,_=p;g<_.length;g++){var v=_[g];u.put(v.cube.entity)}for(var b=new Array,E=function(t){var e=t.cube.action,n=u.out(t.cube.entity,e),r=a.get(n),i=r.filter(function(t){return t.cube.action!==e});i.length>0||a.has(n)===!1?(t.cube.active&&i.filter(function(t){return t.cube.active}).filter(function(e){return e.cube.absorbable(t.cube)||t.cube.absorbable(e.cube)}).forEach(function(e){return f.join(t.index,e.index)}),t.cube.status=s.Stop,b.push(t)):r.forEach(function(e){return e.node.push(t)})},m=0,w=p;m<w.length;m++){var v=w[m];E(v)}for(var A=0,T=p;A<T.length;A++){var v=T[A];if(v.cube.status===s.Free)for(var O=function(t){var e=o.Move.map(function(e){var n=a.get(o.toVec2(e).plus(t));return void 0!==n&&n.cube.status!==s.Stop&&n.cube.action===o.opposite(e)?n:void 0}).filter(function(t){return void 0!==t}).map(function(t){return t});if(e.length>1)for(var n=e.find(function(t){return t.cube.active&&e.every(function(e){return e===t||e.cube.active&&e.cube.absorbable(t.cube)===!1&&t.cube.absorbable(e.cube)===!0})}),r=0,i=e.filter(function(t){return t!==n});r<i.length;r++){var c=i[r];c.cube.status=s.Lock,b.push(c)}},M=0,R=u.out(v.cube.entity,v.cube.action);M<R.length;M++){var C=R[M];O(C)}}for(var U=0,x=b;U<x.length;U++)for(var S=x[U],L=function(t){var e=t.shift();if(void 0===e)return"break";e.cube.active&&e.node.filter(function(t){return t.cube.active}).filter(function(t){return t.cube.absorbable(e.cube)||e.cube.absorbable(t.cube)}).forEach(function(t){return f.join(e.index,t.index)});for(var n=0,r=e.node.filter(function(t){return t.cube.status<e.cube.status});n<r.length;n++){var i=r[n];i.cube.status=e.cube.status,t.push(i)}},N=new Array(S);0!==N.length;){var D=L(N);if("break"===D)break}for(var I=0,P=f.groups();I<P.length;I++){var k=P[I];i(k.map(function(t){return t.cube}))}}function i(t){if(!(t.length<=1)){var e=t.find(function(e){return t.every(function(t){return e===t||e.absorbable(t)})});void 0!==e&&e.absorb(t.filter(function(t){return e!==t}))}}var o=t.Cube.Action,s=t.Cube.Status;e.link=n;var a=function(){function t(t,e){this.cube=t,this.index=e}return t}();__reflect(a.prototype,"Link"),e.move=r;var c=function(){function t(t,e){this.cube=t,this.index=e,this.node=new Array}return t}();__reflect(c.prototype,"Node")}(e=t.Transform||(t.Transform={}))}(logic||(logic={}));var entity;!function(t){var e=logic.Cube.Type,n=(utils.Track,utils.Musician.instance,function(n){function r(){var t=n.call(this)||this;return t.cube=new Array,t.dest=new Array,t.addEventListener(egret.Event.ADDED_TO_STAGE,t.onAddToStage,t),t.floor=new egret.Shape,t.layer=Array.of(new egret.DisplayObjectContainer,new egret.DisplayObjectContainer,new egret.DisplayObjectContainer,new egret.DisplayObjectContainer),t}return __extends(r,n),r.prototype.onAddToStage=function(){for(var t=0,e=this.layer;t<e.length;t++){var n=e[t];this.addChildAt(n,0)}this.sort(),this.addChildAt(this.floor,0)},r.prototype.command=function(t){switch(t){case 1:case 2:case 3:case 4:case 0:this.cube.filter(function(t){return t.type===e.Blue}).forEach(function(e){return e.action=t})}},r.prototype.next=function(){logic.Transform.link(this.cube,this.size.width,this.size.height),logic.Transform.move(this.cube,this.size.width,this.size.height);
for(var t=0,e=this.cube;t<e.length;t++){var n=e[t];n.commit()}this.sort(),this.cube=this.cube.filter(function(t){return t.live})},r.prototype.status=function(){var t=this;return this.dest.map(function(e){return t.cube.some(function(t){return t.entity.some(function(t){return t.x===e.x&&t.y===e.y})})}).map(function(t){return t?1:0})},r.prototype.build=function(e){if(void 0!==e&&(this.seed=e),void 0!==this.seed){this.background();for(var n=0,r=this.layer;n<r.length;n++){var i=r[n];i.removeChildren()}var o=new t.CubeFactory(this,this.layer);this.dest=this.seed.dest.map(function(t){return o.create(t)}),this.cube=this.seed.cube.map(function(t){return o.create(t)}),logic.Transform.link(this.cube,this.size.width,this.size.height),this.sort()}},Object.defineProperty(r.prototype,"size",{get:function(){return void 0!==this.seed?this.seed.size:{width:0,height:0}},enumerable:!0,configurable:!0}),r.prototype.sort=function(){for(var t=0,e=this.layer;t<e.length;t++){var n=e[t];n.$children.sort(function(t,e){return t.x+t.y<e.x+e.y?-1:t.x+t.y>e.x+e.y?1:0})}},r.prototype.background=function(){var t=this.size,e=t.width,n=t.height,r=this.stage.stageWidth,i=this.stage.stageHeight,o=Math.min(r/e,i/n),s=(r-e*o)/2,a=(i-n*o)/2,c=this.floor;c.graphics.clear(),c.graphics.beginFill(2039583),c.graphics.drawRect(0,0,e*o,n*o),c.graphics.endFill(),c.x=s,c.y=a},r}(egret.DisplayObjectContainer));t.World=n,__reflect(n.prototype,"entity.World",["logic.IWorld"])}(entity||(entity={}));var scene;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.progress=0,e.text_progress=new egret.TextField,e.text_guide=new egret.TextField,e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e.addEventListener(eui.UIEvent.COMPLETE,e.onUIComplete,e),e.skinName="layout.Loading",e}return __extends(e,t),e.prototype.onUIComplete=function(){},e.prototype.onAddToStage=function(){this.width=this.stage.stageWidth,this.height=this.stage.stageHeight,Musician.music(utils.Track.BGM_NORMAL)},e.prototype.createChildren=function(){t.prototype.createChildren.call(this),this.addChild(this.text_progress),this.text_progress.textColor=7829367,this.text_progress.x=.5*this.stage.stageHeight,this.text_progress.y=.5*this.stage.stageHeight,this.text_progress.width=480,this.text_progress.height=100,this.text_progress.textAlign="center",this.addChild(this.text_guide)},Object.defineProperty(e.prototype,"track",{set:function(t){this.progress=0,this.groups=t},enumerable:!0,configurable:!0}),e.prototype.count=function(t){void 0===t&&(t=1),this.progress+=t,this.progress>=this.groups.length?(this.progress=this.groups.length-1,this.text_progress.visible=!1):this.text_progress.visible=!0},e.prototype.onProgress=function(t,e){var n=this.groups.length,r=this.progress,i=100/n,o=Math.round(i*r+i*t/e);this.rect_background.width=this.width*o/100,this.text_progress.text="Loading "+o+"%"},e}(eui.Component);t.Loading=e,__reflect(e.prototype,"scene.Loading",["RES.PromiseTaskReporter"])}(scene||(scene={}));var scene;!function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(eui.Component);t.Splash=e,__reflect(e.prototype,"scene.Splash")}(scene||(scene={}));var scene;!function(t){var e=utils.Track,n=utils.Musician.instance,r=function(t){function r(){var e=t.call(this)||this;return e.order=new Array(3),e.guide=new logic.Narrator(new utils.Loader,new utils.Saver),e.world=new entity.World,e.timer=new egret.Timer(250,0),e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e.input=[input.Controller.create(e),input.Controller.create(new input.KeyBoard)],e}return __extends(r,t),r.prototype.onAddToStage=function(){var t=new egret.Shape;this.addChild(t),t.graphics.beginFill(0),t.graphics.drawRect(0,0,this.stage.stageWidth,this.stage.stageHeight),t.graphics.endFill();var e=this.guide.tell();if(void 0===e)throw new Error("Cannot find any Seed");this.addChild(this.world),this.world.build(e);for(var n=0,r=this.input;n<r.length;n++){var i=r[n];i.enable=!0,i.addEventListener(input.Controller.Event.ORDER,this.onControl,this)}this.timer.start(),this.timer.addEventListener(egret.TimerEvent.TIMER,this.onTick,this)},r.prototype.onTick=function(t){if(void 0!==this.world){var e=0;if(this.order.some(function(t){return t!==e})){var n=this.order[0]===e?this.order[1]:this.order[2]===e&&this.order[1]===this.order[0]?this.order[2]:this.order[1];n!==e?this.world.command(n):this.order[1]=n,this.order[0]=n}this.world.next()}},r.prototype.onControl=function(t){switch(t.code){case 5:var r=this.guide.zero();void 0!==r&&this.world.build(r);break;case 8:this.world.build();break;case 6:var i=this.world.status();if(i.some(function(t){return 0!==t})){var r=this.guide.next(i);void 0!==r&&(n.sound(e.LEVEL_ENTER),this.world.build(r))}break;case 9:var r=this.guide.next(this.world.status());void 0!==r&&(n.sound(e.LEVEL_ENTER),this.world.build(r));break;default:input.Controller.Moves.includes(t.code)&&(0!==t.code&&(n.sound(e.CUBE_CONTROL),this.order[1]=t.code),this.order[2]=t.code)}},r}(eui.Component);t.World=r,__reflect(r.prototype,"scene.World")}(scene||(scene={}));var utils;!function(t){var e=function(){function t(){}return t.prototype.has=function(t){return RES.hasRes(t)},t.prototype.get=function(t){return RES.getRes(t)},t}();t.Loader=e,__reflect(e.prototype,"utils.Loader",["logic.ILoader"]);var n=function(){function t(){}return t.prototype.has=function(t){return null!==egret.localStorage.getItem(t)},t.prototype.get=function(t){return JSON.parse(egret.localStorage.getItem(t))},t.prototype.set=function(t,e){egret.localStorage.setItem(t,JSON.stringify(e))},t}();t.Saver=n,__reflect(n.prototype,"utils.Saver",["logic.ISaver"])}(utils||(utils={}));var input;!function(t){var e;!function(t){function e(t){return t instanceof input.KeyBoard?new r(t):t instanceof egret.DisplayObjectContainer?new i(t):new n}t.Moves=[0,1,2,3,4],t.Ctrls=[5,6,7,7,8,9];var o=function(t){function e(e,n,r,i){void 0===r&&(r=!1),void 0===i&&(i=!1);var o=t.call(this,n,r,i)||this;return o.code=e,o}return __extends(e,t),e.ORDER="Order.Event.COMMAND",e}(egret.Event);t.Event=o,__reflect(o.prototype,"input.Controller.Event"),t.create=e}(e=t.Controller||(t.Controller={}));var n=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.enable=!1,e}return __extends(e,t),e}(egret.EventDispatcher);__reflect(n.prototype,"DummyController",["input.Controller"]);var r=function(t){function n(e){var n=t.call(this)||this;return n.input=e,n.state=!1,n.force=[0,0],n}return __extends(n,t),Object.defineProperty(n.prototype,"enable",{get:function(){return this.state},set:function(t){this.state!==t&&(t?(this.input.addEventListener(input.Key.Event.KEY_DOWN,this.onKeyDown,this),this.input.addEventListener(input.Key.Event.KEY_UP,this.onKeyUp,this)):(this.input.removeEventListener(input.Key.Event.KEY_DOWN,this.onKeyDown,this),this.input.removeEventListener(input.Key.Event.KEY_UP,this.onKeyUp,this)),this.state=t)},enumerable:!0,configurable:!0}),n.prototype.onKeyDown=function(t){var n=this.mapper(t.key);if(void 0!==n){if(e.Moves.includes(n)&&0!==n){switch(n){case 1:this.force[0]=Math.max(this.force[0]-1,-1);break;case 2:this.force[1]=Math.min(this.force[1]+1,1);break;case 3:this.force[1]=Math.max(this.force[1]-1,-1);break;case 4:this.force[0]=Math.min(this.force[0]+1,1)}var r=this.toMove();void 0!==r&&(n=r)}this.dispatchEvent(new e.Event(n,e.Event.ORDER,!0,!0))}},n.prototype.onKeyUp=function(t){var n=this.mapper(t.key);if(void 0!==n){if(e.Moves.includes(n)&&0!==n){switch(n){case 1:this.force[0]=Math.min(this.force[0]+1,1);break;case 2:this.force[1]=Math.max(this.force[1]-1,-1);break;case 3:this.force[1]=Math.min(this.force[1]+1,1);break;case 4:this.force[0]=Math.max(this.force[0]-1,-1)}n=this.toMove()||0}e.Moves.includes(n)&&this.dispatchEvent(new e.Event(n,e.Event.ORDER,!0,!0))}},n.prototype.mapper=function(t){var e=new Map([[input.Key.LEFT,1],[input.Key.DOWN,2],[input.Key.UP,3],[input.Key.RIGHT,4],[input.Key.ESC,5],[input.Key.ENTER,6],[input.Key.SPACE,6],[input.Key.P,7],[input.Key.R,8],[input.Key.N,9]]);return e.get(t)},n.prototype.toMove=function(){var t=this.force,e=t[0],n=t[1];switch(!0){default:return;case 0===e&&0===n:return 0;case-1===e&&0===n:return 1;case 0===e&&1===n:return 2;case 0===e&&-1===n:return 3;case 1===e&&0===n:return 4}},n}(egret.EventDispatcher);__reflect(r.prototype,"KeyBoardController",["input.Controller"]);var i=function(t){function n(e){var n=t.call(this)||this;return n.scene=e,n.state=!1,n.moved=!1,n.point=[0,0],n.ctype=0,n.begin=0,n}return __extends(n,t),Object.defineProperty(n.prototype,"enable",{get:function(){return this.state},set:function(t){this.state!==t&&(t?(this.scene.touchEnabled=!0,this.scene.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this),this.scene.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEnd,this)):(this.scene.removeEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEnd,this),this.scene.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this),this.scene.touchEnabled=!1,this.moved=!1,this.ctype=0),this.state=t)},enumerable:!0,configurable:!0}),n.prototype.onTouchTap=function(t){var n=Math.min(this.scene.stage.stageWidth,this.scene.stage.stageHeight),r=Math.min(Math.max(t.stageX/n,0),1),i=Math.min(Math.max(t.stageY/n,0),1),o=.1>r&&.1>i?8:r>.9&&.1>i?5:6;this.dispatchEvent(new e.Event(o,e.Event.ORDER,!0,!0))},n.prototype.onTouchBegin=function(t){this.scene.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMove,this),this.point=[t.stageX,t.stageY],this.begin=Date.now()},n.prototype.onTouchEnd=function(t){this.scene.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMove,this),Date.now()-this.begin<500&&this.moved===!1?this.onTouchTap(t):(this.moved=!1,this.ctype=0,this.dispatchEvent(new e.Event(this.ctype,e.Event.ORDER,!0,!0)))},n.prototype.onTouchMove=function(t){var n=0,r=Math.min(this.scene.stage.stageWidth,this.scene.stage.stageHeight)/2,i=this.point[0]-t.stageX,o=this.point[1]-t.stageY,s=Math.min(Math.max(i/r,-1),1),a=Math.min(Math.max(o/r,-1),1),c=!0;switch(!0){case Math.abs(a)<Math.abs(s)&&.1<Math.abs(s):n=s>0?1:4,this.moved=!0;break;case Math.abs(s)<Math.abs(a)&&.1<Math.abs(a):n=a>0?3:2,this.moved=!0;break;default:c=!1}this.moved&&c&&(this.point=[t.stageX,t.stageY],this.ctype!==n&&(this.ctype=n,this.dispatchEvent(new e.Event(n,e.Event.ORDER,!0,!0))))},n}(egret.EventDispatcher);__reflect(i.prototype,"TouchController",["input.Controller"])}(input||(input={}));var logic;!function(t){var e=function(){function t(t,e){this.width=t,this.height=e}return t.prototype.hasOne=function(t){return 0<=t.x&&t.x<this.width&&0<=t.y&&t.y<this.height},t.prototype.hasAll=function(t){var e=this;return t.every(function(t){return e.hasOne(t)})},t.prototype.setOne=function(t,e){var n=this.hasOne(t);return n&&this.setRaw(t,e),n},t.prototype.setAll=function(t,e){var n=this;return t.map(function(t){return n.setOne(t,e)}).every(function(t){return t})},t.prototype.getAll=function(t){var e=this;return t.filter(function(t){return e.hasOne(t)}).map(function(t){return e.getRaw(t)})},t}();__reflect(e.prototype,"GridBase");var n=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.grid=new Uint8Array(e*n),r}return __extends(e,t),e.prototype.clear=function(){this.grid.fill(0)},e.prototype.getOne=function(t){return this.hasOne(t)?this.getRaw(t):0},e.prototype.getRaw=function(t){return this.grid[this.index(t)]},e.prototype.setRaw=function(t,e){this.grid[this.index(t)]=e},e.prototype.index=function(t){return t.x+t.y*this.width},e}(e);__reflect(n.prototype,"Uint8Grid");var r=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.grid=new Array(e*n),r}return __extends(e,t),e.prototype.has=function(t){return s.isIVec2(t)?this.hasOne(t):this.hasAll(t)},e.prototype.get=function(t){var e=this;if(s.isIVec2(t))return this.getOne(t);var n=t.map(function(t){return e.getOne(t)}).filter(function(t){return void 0!==t}).map(function(t){return t});return n.length<=1?n:Array.from(new Set(n))},e.prototype.set=function(t,e){return s.isIVec2(t)?this.setOne(t,e):this.setAll(t,e)},e.prototype.clear=function(){this.grid.fill(void 0)},e.prototype.getOne=function(t){return this.hasOne(t)?this.getRaw(t):void 0},e.prototype.getRaw=function(t){return this.grid[this.index(t)]},e.prototype.setRaw=function(t,e){this.grid[this.index(t)]=e},e.prototype.index=function(t){return t.x+t.y*this.width},e}(e);t.ItemGrid=r,__reflect(r.prototype,"logic.ItemGrid");var i;!function(t){t[t.L=8]="L",t[t.D=4]="D",t[t.U=2]="U",t[t.R=1]="R"}(i||(i={})),function(e){function n(t,e){return 0!==(t&e)}function r(t){switch(t){default:return t;case e.L:return e.R;case e.D:return e.U;case e.U:return e.D;case e.R:return e.L}}function i(n){switch(n){default:return t.Vec2.Zero;case e.L:return t.Vec2.Left;case e.D:return t.Vec2.Down;case e.U:return t.Vec2.Up;case e.R:return t.Vec2.Right}}function o(n){switch(n){default:return e.Enum;case t.Cube.Action.Left:return[e.L];case t.Cube.Action.Down:return[e.D];case t.Cube.Action.Up:return[e.U];case t.Cube.Action.Right:return[e.R]}}e.Bits=4,e.Mask=(1<<e.Bits)-1,e.Enum=[e.L,e.D,e.U,e.R],e.is=n,e.opposite=r,e.toVec2=i,e.fromAction=o}(i||(i={}));var o=function(e){function n(t,n){return e.call(this,t,n)||this}return __extends(n,e),n.prototype.get=function(t){return this.getOne(t)},n.prototype.put=function(t){for(var e=0,n=t;e<n.length;e++){for(var r=n[e],o=0,s=0,a=i.Enum;s<a.length;s++){var c=a[s],u=i.toVec2(c).plus(r),h=this.getOne(u)>>i.Bits;0!==h?this.setOne(u,(h&~i.opposite(c))<<i.Bits):o|=c<<i.Bits}this.setOne(r,o)}for(var f=0,l=t;f<l.length;f++){var r=l[f];this.setOne(r,this.getOne(r)>>i.Bits)}},n.prototype.out=function(e,n){void 0===n&&(n=t.Cube.Action.Idle);for(var r=new Array,o=i.fromAction(n),s=0,a=e;s<a.length;s++)for(var c=a[s],u=this.getOne(c),h=0,f=o;h<f.length;h++){var l=f[h];i.is(u,l)&&r.push(i.toVec2(l).plus(c))}return r},n}(n);t.EdgeGrid=o,__reflect(o.prototype,"logic.EdgeGrid");var s;!function(t){function e(t){return void 0!==t.x&&void 0!==t.y}t.isIVec2=e}(s||(s={}))}(logic||(logic={}));